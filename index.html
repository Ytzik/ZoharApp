<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZoharApp v32</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap');
        :root {
            --rose: #fb7185; --blue: #3b82f6; --green: #10b981; --red: #ef4444; 
            --amber: #f59e0b; --indigo: #6366f1; --bg: #f1f5f9;
        }
        * { box-sizing: border-box; font-family: 'Assistant', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); margin: 0; padding: 15px; color: #0f172a; direction: rtl; }
        
        #custom-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75); z-index: 9999; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; padding: 25px; 
            border-radius: 24px; text-align: center; box-shadow: 0 20px 25px rgba(0,0,0,0.2);
        }

        .screen { display: none; max-width: 480px; margin: 0 auto; animation: fadeIn 0.2s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 18px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-secondary { background: white; border: 2px solid #e2e8f0; color: #475569; }
        
        .timer { font-size: 48px; font-weight: 800; color: var(--rose); margin: 15px 0; font-family: monospace; }
        .nursing-active { background: var(--red) !important; color: white !important; }
        .bath-active { background: #06b6d4 !important; color: white !important; }
        .med-taken { background: #fef08a !important; border-color: #facc15 !important; } 
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; }
        label { display: block; text-align: right; font-weight: 600; margin-top: 10px; color: #475569; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin: 15px 0; }
        .cal-day { padding: 10px; text-align: center; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: white; font-weight: 600; }
        .cal-today { border: 2px solid var(--amber); background: #fffbeb; }
        .cal-selected { background: var(--indigo) !important; color: white; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 12px; border-radius: 15px; text-align: center; border: 1px solid #e2e8f0; }

        @media print {
            body * { display: none !important; }
            #print-area { display: block !important; width: 100%; padding: 20px; direction: rtl; }
        }
    </style>
</head>
<body>

    <div id="custom-modal">
        <div class="modal-content" id="modal-inner"></div>
    </div>

    <div id="scr-reg" class="screen">
        <h2 style="text-align:center; color:var(--rose);">×™×¦×™×¨×ª ×¤×¨×•×¤×™×œ ×ª×™× ×•×§</h2>
        <div class="card">
            <input type="text" id="reg-name" placeholder="×©× ×”×ª×™× ×•×§">
            <input type="text" id="reg-lname" placeholder="×©× ××©×¤×—×”">
            <select id="reg-gender">
                <option value="">××™×Ÿ ×”×ª×™× ×•×§</option>
                <option value="×–×›×¨">×–×›×¨ ğŸ‘¦</option>
                <option value="× ×§×‘×”">× ×§×‘×” ğŸ‘§</option>
            </select>
            <label>×”×›× ×¡ ××ª ×ª××¨×™×š ×”×œ×™×“×”:</label>
            <input type="date" id="reg-dob">
            <input type="text" id="reg-mom" placeholder="×©× ×”××">
            <input type="text" id="reg-dad" placeholder="×©× ×”××‘">
            <button class="btn" style="background:var(--rose); color:white;" onclick="Core.initProfile()">×©××•×¨ ×•×”×ª×—×œ</button>
        </div>
    </div>

    <div id="scr-home" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="home-hello">×©×œ×•×</h2>
            <span id="gender-icon" style="font-size:24px;"></span>
        </div>
        
        <div class="stats-grid">
            <div class="card" style="margin-bottom:0; text-align:center; border-bottom:4px solid var(--rose);">
                <small>××¨×•×—×” ××—×¨×•× ×”</small>
                <div id="stat-last-feed" style="font-weight:800; font-size:1.1em;">-</div>
            </div>
            <div class="card" style="margin-bottom:0; text-align:center; border-bottom:4px solid var(--amber);">
                <small>×—×™×ª×•×œ ××—×¨×•×Ÿ</small>
                <div id="stat-last-diaper-main" style="font-weight:800; font-size:1.1em;">-</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="card" onclick="Nav.to('scr-nursing')" style="border-right: 5px solid var(--rose)">ğŸ¤± <b>×”× ×§×”</b><br><small id="sub-nursing">-</small></div>
            <div class="card" onclick="Core.openBottleModal()" style="border-right: 5px solid var(--blue)">ğŸ¼ <b>×‘×§×‘×•×§</b><br><small id="sub-bottle">×¨×™×©×•× ×›××•×ª</small></div>
            <div class="card" onclick="Nav.to('scr-diaper')" style="border-right: 5px solid var(--amber)">âœ¨ <b>×—×™×ª×•×œ</b><br><small id="sub-diaper">-</small></div>
            <div class="card" id="card-sleep" onclick="Nav.to('scr-sleep')" style="border-right: 5px solid var(--indigo)">ğŸŒ™ <b>×©×™× ×”</b><br><small id="sub-sleep">0 ×©×¢×•×ª ×•-0 ×“×§×•×ª</small></div>
            <div class="card" onclick="Nav.to('scr-meds')" style="border-right: 5px solid var(--red)">ğŸ’Š <b>×ª×¨×•×¤×•×ª</b></div>
            <div class="card" onclick="Nav.to('scr-meas')" style="border-right: 5px solid var(--green)">ğŸ“ˆ <b>××“×“×™×</b></div>
            <button id="btn-bath" class="btn card" style="grid-column: span 2; border-right: 5px solid #06b6d4;" onclick="Core.doBath()">ğŸ› <b>×¨×—×¦×”</b></button>
        </div>

        <button class="btn btn-secondary" style="margin-top:20px;" onclick="Nav.to('scr-cal')">ğŸ“… ×™×•××Ÿ ×¤×¢×™×œ×•×ª</button>
        <button class="btn" style="background:var(--blue); color:white; margin-top:10px;" onclick="Core.generateReport()">ğŸ“‹ ×”×¤×§ ×“×•×— ×œ×¨×•×¤×</button>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-secondary" style="font-size:12px; flex:1;" onclick="Core.exportData()">ğŸ“¤ ×’×™×‘×•×™</button>
            <button class="btn btn-secondary" style="font-size:12px; flex:1;" onclick="document.getElementById('file-in').click()">ğŸ“¥ ×©×—×–×•×¨</button>
            <input type="file" id="file-in" style="display:none" onchange="Core.importData(event)">
        </div>
    </div>

    <div id="scr-nursing" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="card" style="text-align:center;">
            <p id="n-info" style="color:var(--rose); font-weight:700;">-</p>
            <div id="n-timer" class="timer">00:00</div>
            <div style="display:flex; gap:12px;">
                <button id="btn-R" class="btn btn-secondary" style="height:100px;" onclick="Core.nursingSide('×™××™×Ÿ')">×¦×“ ×™××™×Ÿ</button>
                <button id="btn-L" class="btn btn-secondary" style="height:100px;" onclick="Core.nursingSide('×©×××œ')">×¦×“ ×©×××œ</button>
            </div>
            <button class="btn" style="background:var(--green); color:white; margin-top:25px;" onclick="Core.nursingFinish()">×¡×™×•× ×•×¢×“×›×•×Ÿ ××¨×•×—×”</button>
        </div>
    </div>

    <div id="scr-sleep" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="stats-grid">
            <div class="stat-box">
                <small>××¦×˜×‘×¨ ×”×™×•×</small>
                <div id="sleep-today-stat" style="font-weight:800; font-size:14px;">0 ×©×¢×•×ª ×•-0 ×“×§×•×ª</div>
            </div>
            <div class="stat-box" onclick="Core.openManualSleepModal()" style="border: 2px dashed var(--indigo); cursor: pointer;">
                <small>×”×–× ×” ×™×“× ×™×ª</small>
                <div style="font-size: 12px;">×©×¢×•×ª ×•×“×§×•×ª âœï¸</div>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <div id="s-timer" class="timer">00:00</div>
            <button id="s-btn" class="btn" style="height:120px; background:var(--indigo); color:white;" onclick="Core.toggleSleep()">×”×ª×—×œ×ª ×©×™× ×”</button>
        </div>
    </div>

    <div id="scr-meds" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="card">
            <input type="text" id="m-name" placeholder="×©× ×”×ª×¨×•×¤×”">
            <input type="text" id="m-dose" placeholder="××™× ×•×Ÿ">
            <select id="m-type">
                <option value="hours">×›×œ X ×©×¢×•×ª</option>
                <option value="daily">×¤×¢× ×‘×™×•×</option>
                <option value="days">×›×œ X ×™××™×</option>
            </select>
            <input type="number" id="m-val" placeholder="×¢×¨×š (××¡×¤×¨)">
            <button class="btn" style="background:var(--red); color:white;" onclick="Core.addMed()">×”×•×¡×£ ×ª×¨×•×¤×”</button>
        </div>
        <div id="med-list"></div>
    </div>

    <div id="scr-diaper" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="stats-grid">
            <div class="stat-box">
                <small>×”×—×œ×¤×” ××—×¨×•× ×”</small>
                <div id="diaper-last-box" style="font-size: 13px; font-weight:800;">-</div>
            </div>
            <div class="stat-box">
                <small>×—×™×ª×•×œ×™× ×”×™×•×</small>
                <div id="diaper-count-box" style="font-weight:800;">0</div>
            </div>
        </div>
        <button class="btn card" onclick="Core.confirmDiaper('ğŸ’¦ ×¤×™×¤×™')">ğŸ’¦ ×¤×™×¤×™</button>
        <button class="btn card" onclick="Core.confirmDiaper('ğŸ’© ×§×§×™')">ğŸ’© ×§×§×™</button>
        <button class="btn card" onclick="Core.confirmDiaper('ğŸŒˆ ×’× ×•×’×')">ğŸŒˆ ×’× ×•×’×</button>
    </div>

    <div id="scr-cal" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div id="cal-grid" class="cal-grid"></div>
        <div id="cal-summary-card" class="card" style="text-align:right; background: #eef2ff; display:none; line-height:1.6;"></div>
        <div id="cal-list"></div>
    </div>

    <div id="scr-meas" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="card">
            <p id="meas-last-text" style="text-align:center; font-weight:800; color:var(--indigo);"></p>
            <div style="display:flex; gap:10px;">
                <input type="number" id="ms-w" step="0.001" placeholder="××©×§×œ (×§×´×’)">
                <input type="number" id="ms-h" placeholder="×’×•×‘×” (×¡×´×)">
            </div>
            <button class="btn" style="background:var(--green); color:white;" onclick="Core.saveMeas()">×©××•×¨ ××“×“×™×</button>
        </div>
        <div class="card"><canvas id="chW"></canvas></div>
        <div class="card"><canvas id="chH"></canvas></div>
    </div>

    <div id="print-area" style="display:none;"></div>

<script>
    const DB = {
        logs: JSON.parse(localStorage.getItem('z_logs')) || [],
        meds: JSON.parse(localStorage.getItem('z_meds')) || [],
        meas: JSON.parse(localStorage.getItem('z_meas')) || [],
        prof: JSON.parse(localStorage.getItem('z_prof')) || null,
        sleep: localStorage.getItem('z_sleep') || null,
        bath: localStorage.getItem('z_bath') || 0,
        nState: JSON.parse(localStorage.getItem('z_nstate')) || { side:null, ts:null, baseR:0, baseL:0 },
        lastN: JSON.parse(localStorage.getItem('z_lastN')) || {time:'-', side:'-'},
        save() {
            localStorage.setItem('z_logs', JSON.stringify(this.logs));
            localStorage.setItem('z_meds', JSON.stringify(this.meds));
            localStorage.setItem('z_meas', JSON.stringify(this.meas));
            localStorage.setItem('z_prof', JSON.stringify(this.prof));
            localStorage.setItem('z_bath', this.bath);
            if(this.sleep) localStorage.setItem('z_sleep', this.sleep); else localStorage.removeItem('z_sleep');
            localStorage.setItem('z_nstate', JSON.stringify(this.nState));
            localStorage.setItem('z_lastN', JSON.stringify(this.lastN));
        }
    };

    const Nav = {
        to(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-home') UI.home();
            if(id === 'scr-nursing') UI.nursing();
            if(id === 'scr-meds') UI.meds();
            if(id === 'scr-meas') UI.meas();
            if(id === 'scr-cal') UI.cal();
            if(id === 'scr-sleep') UI.sleep();
            if(id === 'scr-diaper') UI.diaper();
        }
    };

    const UI = {
        modal(html) {
            document.getElementById('modal-inner').innerHTML = html;
            document.getElementById('custom-modal').style.display = 'flex';
        },
        close() { document.getElementById('custom-modal').style.display = 'none'; },
        
        formatToHoursAndMins(totalMins) {
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h} ×©×¢×•×ª ×•-${m} ×“×§×•×ª`;
        },

        home() {
            if(!DB.prof) return Nav.to('scr-reg');
            document.getElementById('home-hello').innerText = `×”×™×•× ×©×œ ${DB.prof.name}`;
            document.getElementById('gender-icon').innerText = DB.prof.gender === '×–×›×¨' ? 'ğŸ‘¦' : 'ğŸ‘§';
            const lastF = DB.logs.find(l => l.type==='×”× ×§×”' || l.type==='×‘×§×‘×•×§');
            document.getElementById('stat-last-feed').innerText = lastF ? lastF.time : '-';
            const lastB = DB.logs.find(l => l.type==='×‘×§×‘×•×§');
            document.getElementById('sub-bottle').innerText = lastB ? `${lastB.time} (${lastB.detail})` : '×¨×™×©×•× ×›××•×ª';
            const lastD = DB.logs.find(l => l.type==='×—×™×ª×•×œ');
            document.getElementById('stat-last-diaper-main').innerText = lastD ? `${lastD.time} (${lastD.detail.replace(' ×—×™×ª×•×œ','')})` : '-';
            const today = new Date().toLocaleDateString('en-GB');
            document.getElementById('sub-diaper').innerText = lastD ? `××—×¨×•×Ÿ: ${lastD.time}` : '×˜×¨× ×”×•×—×œ×£';
            document.getElementById('sub-nursing').innerText = `${DB.lastN.time} (${DB.lastN.side})`;
            document.getElementById('sub-sleep').innerText = `${this.formatToHoursAndMins(Core.getDailySleepMins(today))} ×”×™×•×`;
            const b = document.getElementById('btn-bath');
            if(Date.now() - DB.bath < 86400000) b.classList.add('bath-active'); else b.classList.remove('bath-active');
        },
        
        nursing() {
            document.getElementById('n-info').innerText = `××—×¨×•× ×”: ${DB.lastN.time} (×¦×“ ${DB.lastN.side})`;
            document.getElementById('btn-R').classList.remove('nursing-active');
            document.getElementById('btn-L').classList.remove('nursing-active');
            clearInterval(window.nI);
            if(DB.nState.side) {
                const b = document.getElementById(DB.nState.side === '×™××™×Ÿ' ? 'btn-R' : 'btn-L');
                b.classList.add('nursing-active');
                window.nI = setInterval(() => {
                    const elapsedSec = Math.floor((Date.now() - DB.nState.ts) / 1000);
                    const currentTotal = (DB.nState.side === '×™××™×Ÿ' ? DB.nState.baseR : DB.nState.baseL) + elapsedSec;
                    document.getElementById('n-timer').innerText = Math.floor(currentTotal/60).toString().padStart(2,'0') + ":" + (currentTotal%60).toString().padStart(2,'0');
                }, 1000);
            } else {
                const total = DB.nState.baseR + DB.nState.baseL;
                document.getElementById('n-timer').innerText = Math.floor(total/60).toString().padStart(2,'0') + ":" + (total%60).toString().padStart(2,'0');
            }
        },

        meds() {
            document.getElementById('med-list').innerHTML = DB.meds.map(m => {
                const lastLog = DB.logs.find(l => l.type === '×ª×¨×•×¤×”' && l.detail === m.name);
                const isTaken = lastLog && (Date.now() - lastLog.ts < m.interval);
                return `<div class="card ${isTaken ? 'med-taken' : ''}" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${m.name}</b><br><small>${m.dose} | ${m.text}</small></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn" style="width:auto; padding:8px; background:var(--green); color:white;" onclick="Core.takeMed(${m.id})">× ×˜×™×œ×”</button>
                        <button class="btn" style="width:auto; padding:8px; background:#f1f5f9;" onclick="Core.deleteMed(${m.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            }).join('');
        },

        cal(dateStr) {
            const sel = dateStr || new Date().toLocaleDateString('en-GB');
            const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
            const todayD = new Date().getDate();
            for(let i=1; i<=31; i++) {
                const d = i.toString().padStart(2,'0') + "/" + (new Date().getMonth()+1).toString().padStart(2,'0') + "/" + new Date().getFullYear();
                grid.innerHTML += `<div onclick="UI.cal('${d}')" class="cal-day ${i===todayD?'cal-today':''} ${sel===d?'cal-selected':''}">${i}</div>`;
            }
            const logs = DB.logs.filter(l => l.date === sel);
            const daySleep = Core.getDailySleepMins(sel);
            const dayFeeds = logs.filter(l => l.type === '×”× ×§×”' || l.type === '×‘×§×‘×•×§').length;
            const sumCard = document.getElementById('cal-summary-card');
            sumCard.style.display = 'block';
            sumCard.innerHTML = `<b>×¡×”"×› ××¨×•×—×•×ª ×”×™×•×:</b> ${dayFeeds}<br><b>×¡×™×›×•× ×©×™× ×” ×™×•××™:</b> ${this.formatToHoursAndMins(daySleep)}`;
            document.getElementById('cal-list').innerHTML = `<h3 style="text-align:center;">${sel}</h3>` + 
                (logs.length ? logs.map(l => `<div class="card"><b>${l.time}</b> | ${l.type}: ${l.detail}</div>`).join('') : `<p style="text-align:center; color:gray;">××™×Ÿ × ×ª×•× ×™×</p>`);
        },

        sleep() {
            const today = new Date().toLocaleDateString('en-GB');
            document.getElementById('sleep-today-stat').innerText = this.formatToHoursAndMins(Core.getDailySleepMins(today));
            const b = document.getElementById('s-btn');
            if(DB.sleep) {
                b.innerText = "×‘×•×§×¨ ×˜×•×‘! â˜€ï¸"; b.style.background = "var(--amber)";
                if(window.sI) clearInterval(window.sI);
                window.sI = setInterval(() => {
                    const diff = Math.floor((Date.now() - DB.sleep)/1000);
                    document.getElementById('s-timer').innerText = Math.floor(diff/60).toString().padStart(2,'0') + ":" + (diff%60).toString().padStart(2,'0');
                }, 1000);
            } else { b.innerText = "×”×ª×—×œ×ª ×©×™× ×” ğŸŒ™"; b.style.background = "var(--indigo)"; document.getElementById('s-timer').innerText = "00:00"; clearInterval(window.sI); }
        },

        diaper() {
            const today = new Date().toLocaleDateString('en-GB');
            const lastD = DB.logs.find(l => l.type==='×—×™×ª×•×œ');
            document.getElementById('diaper-last-box').innerText = lastD ? `${lastD.time} (${lastD.detail})` : '-';
            document.getElementById('diaper-count-box').innerText = DB.logs.filter(l => l.date === today && l.type === '×—×™×ª×•×œ').length;
        },

        meas() {
            const last = DB.meas[DB.meas.length-1];
            document.getElementById('meas-last-text').innerText = last ? `××—×¨×•×Ÿ: ${last.w} ×§"×’ ×‘-${last.date}` : "××™×Ÿ ××“×“×™×";
            
            // ×¢×™×‘×•×“ × ×ª×•× ×™× ×œ×’×¨×£ - ×¨×§ ××“×™×“×” ××—×¨×•× ×” ×œ×›×œ ×™×•×
            const distinctMeas = [];
            const seenDates = new Set();
            [...DB.meas].reverse().forEach(m => {
                if(!seenDates.has(m.date)) {
                    distinctMeas.unshift(m);
                    seenDates.add(m.date);
                }
            });

            if(window.cW) window.cW.destroy(); if(window.cH) window.cH.destroy();
            const cfg = (l, d, c, labels) => ({ type:'line', data:{labels:labels, datasets:[{label:l, data:d, borderColor:c, tension:0.2}]} });
            
            const labels = distinctMeas.map(m=>m.date);
            window.cW = new Chart(document.getElementById('chW'), cfg('××©×§×œ', distinctMeas.map(m=>m.w), '#3b82f6', labels));
            window.cH = new Chart(document.getElementById('chH'), cfg('×’×•×‘×”', distinctMeas.map(m=>m.h), '#10b981', labels));
        }
    };

    const Core = {
        initProfile() {
            const n = document.getElementById('reg-name').value;
            if(!n) return alert("×©× ×—×•×‘×”");
            DB.prof = { name:n, lname:document.getElementById('reg-lname').value, gender:document.getElementById('reg-gender').value, dob:document.getElementById('reg-dob').value, mom:document.getElementById('reg-mom').value, dad:document.getElementById('reg-dad').value };
            DB.save(); Nav.to('scr-home');
        },
        
        log(type, detail) {
            const now = new Date();
            DB.logs.unshift({ type, detail, time: now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}), date: now.toLocaleDateString('en-GB'), ts: Date.now() });
            DB.save(); UI.home();
        },

        getDailySleepMins(dateStr) {
            return DB.logs
                .filter(l => l.date === dateStr && l.type === '×©×™× ×”')
                .reduce((acc, l) => acc + (parseInt(l.detail) || 0), 0);
        },

        doBath() {
            if(Date.now() - DB.bath < 86400000) UI.modal(`<h3>×›×‘×¨ ×‘×•×¦×¢</h3><p>×¨×—×¦×ª ×›×‘×¨ ×”×™×•×.</p><button class="btn" onclick="UI.close()">×¡×’×•×¨</button>`);
            else { DB.bath = Date.now(); this.log('×¨×—×¦×”', 'ğŸ› ×‘×•×¦×¢×” ×¨×—×¦×”'); }
        },

        openBottleModal() {
            const lastB = DB.logs.find(l => l.type==='×‘×§×‘×•×§');
            const preview = lastB ? `<p style="background:#f1f5f9; padding:10px; border-radius:10px;"><small>××¨×•×—×” ××—×¨×•× ×”:</small><br><b>${lastB.date} ×‘-${lastB.time} (${lastB.detail})</b></p>` : '';
            UI.modal(`<h3>ğŸ¼ ×‘×§×‘×•×§</h3>${preview}<input type="number" id="b-amt" placeholder="××´×œ"><button class="btn" style="background:var(--blue); color:white;" onclick="Core.saveBottle()">×©××•×¨</button><button class="btn btn-secondary" style="margin-top:10px;" onclick="UI.close()">×‘×™×˜×•×œ</button>`);
        },

        saveBottle() {
            const a = document.getElementById('b-amt').value;
            if(a) { this.log('×‘×§×‘×•×§', a + ' ×"×œ'); UI.close(); }
        },

        confirmDiaper(type) {
            UI.modal(`<h3>××™×©×•×¨ ×”×—×œ×¤×”</h3><p>×—×™×ª×•×œ ×¢× ${type}?</p><button class="btn" style="background:var(--amber); color:white;" onclick="Core.log('×—×™×ª×•×œ', '${type}'); UI.close(); Nav.to('scr-diaper');">××©×¨</button><button class="btn btn-secondary" onclick="UI.close()">×‘×˜×œ</button>`);
        },

        nursingSide(side) {
            const now = Date.now();
            if(DB.nState.side === side) {
                const diff = Math.floor((now - DB.nState.ts) / 1000);
                if(side === '×™××™×Ÿ') DB.nState.baseR += diff; else DB.nState.baseL += diff;
                DB.nState.side = null; DB.nState.ts = null;
            } else {
                if(DB.nState.side) {
                    const diff = Math.floor((now - DB.nState.ts) / 1000);
                    if(DB.nState.side === '×™××™×Ÿ') DB.nState.baseR += diff; else DB.nState.baseL += diff;
                }
                DB.nState.side = side;
                DB.nState.ts = now;
            }
            DB.save(); UI.nursing();
        },

        nursingFinish() {
            if(DB.nState.side) {
                const diff = Math.floor((Date.now() - DB.nState.ts) / 1000);
                if(DB.nState.side === '×™××™×Ÿ') DB.nState.baseR += diff; else DB.nState.baseL += diff;
            }
            const total = DB.nState.baseR + DB.nState.baseL;
            if(total < 30) { DB.nState = {side:null, ts:null, baseR:0, baseL:0}; DB.save(); return Nav.to('scr-home'); }
            DB.lastN = { time: new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}), side: DB.nState.baseR >= DB.nState.baseL ? '×™××™×Ÿ' : '×©×××œ' };
            this.log('×”× ×§×”', `×™××™×Ÿ: ${Math.floor(DB.nState.baseR/60)} ×“×§', ×©×××œ: ${Math.floor(DB.nState.baseL/60)} ×“×§'`);
            DB.nState = {side:null, ts:null, baseR:0, baseL:0}; DB.save(); Nav.to('scr-home');
        },

        toggleSleep() {
            if(!DB.sleep) DB.sleep = Date.now();
            else { const mins = Math.floor((Date.now()-DB.sleep)/60000); this.log('×©×™× ×”', `${mins} ×“×§×•×ª`); DB.sleep = null; }
            DB.save(); UI.sleep();
        },

        openManualSleepModal() {
            UI.modal(`<h3>×©×™× ×” ×™×“× ×™×ª</h3><div style="display:flex; gap:5px;"><input type="number" id="man-h" placeholder="×©×¢×•×ª"><input type="number" id="man-m" placeholder="×“×§×•×ª"></div><button class="btn" style="background:var(--indigo); color:white; margin-top:10px;" onclick="Core.saveManualSleep(true)">×”×•×¡×£ ××§×˜×¢</button><button class="btn" style="background:var(--amber); color:white;" onclick="Core.saveManualSleep(false)">×§×‘×¢ ×¡×š ×™×•××™</button>`);
        },

        saveManualSleep(isSeg) {
            const h = parseInt(document.getElementById('man-h').value) || 0, m = parseInt(document.getElementById('man-m').value) || 0;
            const total = (h * 60) + m;
            if(!isSeg) DB.logs = DB.logs.filter(l => !(l.date === new Date().toLocaleDateString('en-GB') && l.type === '×©×™× ×”'));
            this.log('×©×™× ×”', `${total} ×“×§×•×ª`); UI.close(); UI.sleep();
        },

        addMed() {
            const n = document.getElementById('m-name'), d = document.getElementById('m-dose'), t = document.getElementById('m-type'), v = document.getElementById('m-val');
            if(!n.value) return;
            let ms = t.value==='daily' ? 86400000 : (t.value==='hours' ? v.value*3600000 : v.value*86400000);
            DB.meds.push({ id:Date.now(), name:n.value, dose:d.value, interval:ms, text: t.value==='daily' ? "×¤×¢× ×‘×™×•×" : (t.value==='hours' ? `×›×œ ${v.value} ×©×¢×•×ª` : `×›×œ ${v.value} ×™××™×`) });
            DB.save(); 
            // ××™×¤×•×¡ ×©×“×•×ª
            n.value = ''; d.value = ''; v.value = ''; t.selectedIndex = 0;
            UI.meds();
        },

        takeMed(id) {
            const med = DB.meds.find(m => m.id === id);
            const lastLog = DB.logs.find(l => l.type === '×ª×¨×•×¤×”' && l.detail === med.name);
            if(lastLog && (Date.now() - lastLog.ts < med.interval)) {
                UI.modal(`<h3>××–×”×¨×”</h3><p>×›×‘×¨ × ×œ×§×—×”.</p><button class="btn" onclick="Core.log('×ª×¨×•×¤×”','${med.name}'); UI.close(); UI.meds();">××©×¨ × ×˜×™×œ×” × ×•×¡×¤×ª</button><button class="btn btn-secondary" onclick="UI.close()">×‘×™×˜×•×œ</button>`);
            } else { this.log('×ª×¨×•×¤×”', med.name); UI.meds(); }
        },

        deleteMed(id) { DB.meds = DB.meds.filter(m=>m.id!==id); DB.save(); UI.meds(); },

        saveMeas() {
            const w = document.getElementById('ms-w').value, h = document.getElementById('ms-h').value;
            const today = new Date().toLocaleDateString('en-GB');
            const exists = DB.meas.findIndex(m => m.date === today);
            
            if(exists !== -1) {
                UI.modal(`<h3>×¢×“×›×•×Ÿ ××“×“</h3><p>×›×‘×¨ ×§×™×™× ××“×“ ×œ×”×™×•×. ×”×× ×œ×¢×“×›×Ÿ ××•×ª×•?</p><button class="btn" onclick="Core.confirmUpdateMeas(${exists},'${w}','${h}')">×¢×“×›×Ÿ</button><button class="btn btn-secondary" onclick="UI.close()">×‘×™×˜×•×œ</button>`);
            } else {
                this.confirmMeas(w,h);
            }
        },

        confirmMeas(w, h) {
            DB.meas.push({ w, h, date: new Date().toLocaleDateString('en-GB'), ts: Date.now() });
            DB.save(); UI.close(); Nav.to('scr-home');
        },

        confirmUpdateMeas(index, w, h) {
            DB.meas[index] = { w, h, date: new Date().toLocaleDateString('en-GB'), ts: Date.now() };
            DB.save(); UI.close(); Nav.to('scr-home');
        },

        generateReport() {
            const p = DB.prof; const today = new Date().toLocaleDateString('en-GB');
            const logs = DB.logs.filter(l => l.date === today);
            const html = `<div style="direction:rtl; text-align:right;"><h1>×“×•×—: ${p.name}</h1><p>×ª××¨×™×š: ${today}</p><hr>${logs.map(l => `<p><b>${l.time}</b>: ${l.type} - ${l.detail}</p>`).join('')}</div>`;
            const area = document.getElementById('print-area'); area.innerHTML = html; area.style.display = 'block';
            setTimeout(() => { window.print(); area.style.display = 'none'; }, 500);
        },

        exportData() {
            const blob = new Blob([JSON.stringify(DB)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `zohar_backup.json`; a.click();
        },

        importData(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { Object.assign(DB, JSON.parse(ev.target.result)); DB.save(); location.reload(); };
            reader.readAsText(e.target.files[0]);
        }
    };

    Nav.to('scr-home');
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZoharApp - Final Professional v21</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;800&display=swap');
        :root {
            --rose: #fb7185; --bg: #f8fafc; --card-bg: white; --text: #1e293b;
            --blue: #3b82f6; --green: #10b981; --red: #ef4444; --amber: #f59e0b; --indigo: #6366f1;
        }
        * { box-sizing: border-box; font-family: 'Assistant', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .screen { display: none; max-width: 450px; margin: 0 auto; }
        .active { display: block; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; text-align: center; }

        /* Design Elements */
        .btn-bar { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 4px solid #ddd; }
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; border-bottom: 3px solid #eee; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
        .timer { font-size: 45px; font-weight: 800; text-align: center; margin: 20px 0; color: var(--rose); font-family: monospace; }
        .active-side { background: #ffe4e6 !important; border: 2px solid var(--rose) !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Report Printing */
        @media print {
            body * { display: none !important; }
            #print-section { display: block !important; direction: rtl; padding: 30px; }
            #print-section * { display: block !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid black; padding: 10px; text-align: right; }
        }
    </style>
</head>
<body>

<div id="modal-bottle" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--blue)">ğŸ¼ ×›××” ×"×œ ××›×œ× ×•?</h2>
        <input type="number" id="bottle-input" placeholder="×”×›× ×¡ ×›××•×ª ×‘××´×œ">
        <button class="btn-bar" style="background:var(--blue); color:white; justify-content:center;" onclick="saveBottle()">×©××•×¨ ×¨×™×©×•×</button>
        <button style="border:none; background:none; color:gray;" onclick="closeModal('modal-bottle')">×‘×™×˜×•×œ</button>
    </div>
</div>

<div id="modal-med-warning" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--red)">âš ï¸ ××–×”×¨×ª ××™× ×•×Ÿ!</h2>
        <p id="med-warning-text"></p>
        <button class="btn-bar" style="background:var(--red); color:white; justify-content:center;" id="btn-confirm-med">×× ×™ ×××©×¨ × ×˜×™×œ×” ×‘×›×œ ×–××ª</button>
        <button class="btn-bar" style="justify-content:center;" onclick="closeModal('modal-med-warning')">×‘×™×˜×•×œ</button>
    </div>
</div>

<div id="main-app">
    <div id="scr-onboarding" class="screen">
        <h1 style="color:var(--rose); text-align:center;">×”×’×“×¨×ª ×¤×¨×•×¤×™×œ ×—×“×© ğŸ‘¶</h1>
        <input type="text" id="p-name" placeholder="×©× ×”×ª×™× ×•×§/×ª">
        <input type="text" id="p-lname" placeholder="×©× ××©×¤×—×”">
        <label>×ª××¨×™×š ×œ×™×“×”:</label>
        <input type="date" id="p-dob">
        <input type="text" id="p-mom" placeholder="×©× ×”××">
        <input type="text" id="p-dad" placeholder="×©× ×”××‘">
        <button class="btn-bar" style="background:var(--rose); color:white; justify-content:center;" onclick="saveProfile()">×‘×•××• × ×ª×—×™×œ!</button>
    </div>

    <div id="scr-home" class="screen">
        <h2 id="welcome-msg" style="color:var(--rose); margin-bottom:5px;">×©×œ×•×</h2>
        <p id="last-nursing-info" style="font-size:14px; margin-top:0;">×”× ×§×” ××—×¨×•× ×”: -</p>
        
        <div class="bento-grid">
            <div class="card" onclick="showScreen('scr-nursing')" style="border-right: 4px solid var(--rose);">ğŸ¤± <b>×”× ×§×”</b></div>
            <div class="card" onclick="openModal('modal-bottle')" style="border-right: 4px solid var(--blue);">ğŸ¼ <b>×‘×§×‘×•×§</b></div>
            <div class="card" onclick="showScreen('scr-diaper')" style="border-right: 4px solid var(--amber);">âœ¨ <b>×—×™×ª×•×œ</b></div>
            <div id="card-sleep" class="card" onclick="showScreen('scr-sleep')" style="border-right: 4px solid var(--indigo);">ğŸŒ™ <b>×©×™× ×”</b></div>
            <div class="card" onclick="showScreen('scr-meds')" style="border-right: 4px solid var(--red);">ğŸ’Š <b>×ª×¨×•×¤×•×ª</b></div>
            <div class="card" onclick="showScreen('scr-measures')" style="border-right: 4px solid var(--green);">ğŸ“ˆ <b>××“×“×™×</b></div>
            <div class="card" onclick="logAction('×¨×—×¦×”', '×‘×•×¦×¢×” ×¨×—×¦×” ğŸ›')" style="grid-column: span 2; border-right: 4px solid #06b6d4;">ğŸ› <b>×¨×—×¦×”</b></div>
        </div>

        <button class="btn-bar" style="margin-top:20px;" onclick="showScreen('scr-history')">ğŸ“… ×™×•××Ÿ ×¤×¢×™×œ×•×ª (31 ×™×•×) <span>â¯</span></button>
        <button class="btn-bar" style="background:var(--blue); color:white; justify-content:center;" onclick="generateReport()">ğŸ“‹ ×”×¤×§ ×“×•×— PDF ×œ×¨×•×¤×</button>
    </div>

    <div id="scr-nursing" class="screen">
        <h2 style="text-align:center;">××¢×§×‘ ×”× ×§×”</h2>
        <div id="n-timer" class="timer">00:00</div>
        <div style="display:flex; gap:10px;">
            <button id="btn-R" class="btn-bar" style="height:100px; justify-content:center;" onclick="toggleNursing('×™××™×Ÿ')">×™××™×Ÿ</button>
            <button id="btn-L" class="btn-bar" style="height:100px; justify-content:center;" onclick="toggleNursing('×©×××œ')">×©×××œ</button>
        </div>
        <button class="btn-bar" style="background:var(--green); color:white; justify-content:center; margin-top:20px;" onclick="finishNursing()">×¡×™×•× ××¨×•×—×”</button>
        <button class="btn-bar" style="background:none; border:none; justify-content:center;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>

    <div id="scr-sleep" class="screen">
        <h2 style="text-align:center;">××¢×§×‘ ×©×™× ×”</h2>
        <div id="s-timer" class="timer">00:00</div>
        <button id="btn-sleep-toggle" class="btn-bar" style="height:100px; justify-content:center; background:var(--indigo); color:white;" onclick="toggleSleep()">×”×ª×—×œ×ª ×©×™× ×”</button>
        <button class="btn-bar" style="background:none; border:none; justify-content:center; margin-top:20px;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>

    <div id="scr-meds" class="screen">
        <h2>ğŸ’Š ×ª×¨×•×¤×•×ª</h2>
        <div style="background:#eee; padding:15px; border-radius:15px; margin-bottom:15px;">
            <input type="text" id="m-name" placeholder="×©× ×”×ª×¨×•×¤×” (×œ××©×œ: × ×•×‘×™××•×œ)">
            <input type="text" id="m-dose" placeholder="××™× ×•×Ÿ (×œ××©×œ: 2 ××´×œ)">
            <input type="number" id="m-hours" placeholder="×›×œ ×›××” ×©×¢×•×ª? (×œ××©×œ: 6)">
            <button class="btn-bar" style="background:var(--indigo); color:white; justify-content:center; margin:0;" onclick="addMedication()">×”×•×¡×£ ×ª×¨×•×¤×” ×œ×¨×©×™××”</button>
        </div>
        <div id="med-list-container"></div>
        <button class="btn-bar" style="background:none; border:none; justify-content:center;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>

    <div id="scr-diaper" class="screen">
        <h2 style="text-align:center;">×ª×™×¢×•×“ ×—×™×ª×•×œ</h2>
        <button class="btn-bar" onclick="logAction('×—×™×ª×•×œ', 'ğŸ’¦ ×¤×™×¤×™')">ğŸ’¦ ×¤×™×¤×™</button>
        <button class="btn-bar" onclick="logAction('×—×™×ª×•×œ', 'ğŸ’© ×§×§×™')">ğŸ’© ×§×§×™</button>
        <button class="btn-bar" onclick="logAction('×—×™×ª×•×œ', 'ğŸŒˆ ×’× ×•×’×')">ğŸŒˆ ×’× ×•×’×</button>
        <button class="btn-bar" style="background:none; border:none; justify-content:center;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>

    <div id="scr-measures" class="screen">
        <h2>ğŸ“ˆ ××“×“×™ ×’×“×™×œ×”</h2>
        <p id="last-measure-text" style="font-weight:bold; color:var(--indigo);"></p>
        <input type="number" id="ms-w" step="0.001" placeholder="××©×§×œ (×§×´×’)">
        <input type="number" id="ms-h" placeholder="×’×•×‘×” (×¡×´×)">
        <button class="btn-bar" style="background:var(--green); color:white; justify-content:center;" onclick="saveMeasure()">×©××•×¨ ××“×“×™×</button>
        <canvas id="chartW" style="margin-top:20px;"></canvas>
        <button class="btn-bar" style="background:none; border:none; justify-content:center;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>

    <div id="scr-history" class="screen">
        <h2>ğŸ“… ×™×•××Ÿ ×¤×¢×™×œ×•×ª</h2>
        <div id="cal-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; margin-bottom:15px;"></div>
        <div id="history-list"></div>
        <button class="btn-bar" style="background:none; border:none; justify-content:center;" onclick="showScreen('scr-home')">×—×–×¨×”</button>
    </div>
</div>

<div id="print-section" style="display:none;"></div>

<script>
    // State Management
    let db = {
        profile: JSON.parse(localStorage.getItem('z_prof')) || null,
        logs: JSON.parse(localStorage.getItem('z_logs')) || [],
        meds: JSON.parse(localStorage.getItem('z_meds')) || [],
        measures: JSON.parse(localStorage.getItem('z_meas')) || [],
        sleepStart: localStorage.getItem('z_sleep') || null,
        lastNursing: JSON.parse(localStorage.getItem('z_lastN')) || {side: '-', time: '-'}
    };

    function save() {
        localStorage.setItem('z_prof', JSON.stringify(db.profile));
        localStorage.setItem('z_logs', JSON.stringify(db.logs));
        localStorage.setItem('z_meds', JSON.stringify(db.meds));
        localStorage.setItem('z_meas', JSON.stringify(db.measures));
        localStorage.setItem('z_lastN', JSON.stringify(db.lastNursing));
        if(db.sleepStart) localStorage.setItem('z_sleep', db.sleepStart);
        else localStorage.removeItem('z_sleep');
    }

    // Navigation
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'scr-home') updateHome();
        if(id === 'scr-meds') renderMeds();
        if(id === 'scr-history') renderCalendar();
        if(id === 'scr-measures') renderCharts();
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Onboarding
    function saveProfile() {
        const name = document.getElementById('p-name').value;
        const lname = document.getElementById('p-lname').value;
        if(!name || !lname) return alert("× × ×œ××œ× ×©× ×•×©× ××©×¤×—×”");
        db.profile = { 
            name, lname, 
            dob: document.getElementById('p-dob').value,
            mom: document.getElementById('p-mom').value,
            dad: document.getElementById('p-dad').value
        };
        save();
        initApp();
    }

    function updateHome() {
        document.getElementById('welcome-msg').innerText = `×”×™×•× ×©×œ ${db.profile.name} ${db.profile.lname}`;
        document.getElementById('last-nursing-info').innerText = `×”× ×§×” ××—×¨×•× ×”: ${db.lastNursing.time} (×¦×“ ${db.lastNursing.side})`;
        
        const cardSleep = document.getElementById('card-sleep');
        if(db.sleepStart) {
            cardSleep.style.background = 'var(--indigo)';
            cardSleep.style.color = 'white';
        } else {
            cardSleep.style.background = 'white';
            cardSleep.style.color = 'var(--text)';
        }
    }

    // Actions
    function logAction(type, detail) {
        const now = new Date();
        db.logs.unshift({
            type, detail,
            time: now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}),
            date: now.toLocaleDateString('en-GB'),
            ts: Date.now()
        });
        save();
        showScreen('scr-home');
    }

    function saveBottle() {
        const amt = document.getElementById('bottle-input').value;
        if(!amt) return;
        logAction('×‘×§×‘×•×§', amt + ' ×"×œ');
        document.getElementById('bottle-input').value = '';
        closeModal('modal-bottle');
    }

    // Nursing Logic
    let nTimer, nStart, nSide = null, nDurs = {R:0, L:0};
    function toggleNursing(side) {
        if(nSide === side) {
            nDurs[side==='×™××™×Ÿ'?'R':'L'] += Math.floor((Date.now()-nStart)/1000);
            nSide = null;
            clearInterval(nTimer);
            document.getElementById('btn-R').classList.remove('active-side');
            document.getElementById('btn-L').classList.remove('active-side');
        } else {
            if(nSide) toggleNursing(nSide);
            nSide = side; nStart = Date.now();
            document.getElementById(side==='×™××™×Ÿ'?'btn-R':'btn-L').classList.add('active-side');
            nTimer = setInterval(() => {
                const totalSec = nDurs[side==='×™××™×Ÿ'?'R':'L'] + Math.floor((Date.now()-nStart)/1000);
                document.getElementById('n-timer').innerText = Math.floor(totalSec/60).toString().padStart(2,'0') + ":" + (totalSec%60).toString().padStart(2,'0');
            }, 1000);
        }
    }
    function finishNursing() {
        if(nSide) toggleNursing(nSide);
        const total = `×™××™×Ÿ: ${Math.floor(nDurs.R/60)} ×“×§', ×©×××œ: ${Math.floor(nDurs.L/60)} ×“×§'`;
        db.lastNursing = { time: new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}), side: nDurs.R > nDurs.L ? '×™××™×Ÿ' : '×©×××œ' };
        logAction('×”× ×§×”', total);
        nDurs = {R:0, L:0}; document.getElementById('n-timer').innerText = "00:00";
    }

    // Sleep Logic
    function toggleSleep() {
        if(!db.sleepStart) {
            db.sleepStart = Date.now();
            document.getElementById('btn-sleep-toggle').innerText = "×œ×”×ª×¢×•×¨×¨ â˜€ï¸";
            document.getElementById('btn-sleep-toggle').style.background = "var(--amber)";
        } else {
            const diff = Math.floor((Date.now() - db.sleepStart) / 60000);
            logAction('×©×™× ×”', `×™×©× ×” ${diff} ×“×§×•×ª`);
            db.sleepStart = null;
            document.getElementById('btn-sleep-toggle').innerText = "×”×ª×—×œ×ª ×©×™× ×” ğŸŒ™";
            document.getElementById('btn-sleep-toggle').style.background = "var(--indigo)";
        }
        save();
    }

    // Meds Logic
    function addMedication() {
        const name = document.getElementById('m-name');
        const dose = document.getElementById('m-dose');
        const hrs = document.getElementById('m-hours');
        if(!name.value) return;
        db.meds.push({
            id: Date.now(),
            name: name.value,
            dose: dose.value,
            hours: hrs.value
        });
        save();
        // × ×™×§×•×™ ×©×“×•×ª
        name.value = ''; dose.value = ''; hrs.value = '';
        renderMeds();
    }

    function renderMeds() {
        const container = document.getElementById('med-list-container');
        container.innerHTML = db.meds.map(m => `
            <div class="btn-bar">
                <div><b>${m.name}</b> (${m.dose})<br><small>×›×œ ${m.hours} ×©×¢×•×ª</small></div>
                <button onclick="takeMed(${m.id})" style="background:var(--green); color:white; border:none; padding:10px; border-radius:10px;">× ×˜×™×œ×”</button>
            </div>
        `).join('');
    }

    function takeMed(id) {
        const med = db.meds.find(m => m.id === id);
        const lastTaken = db.logs.find(l => l.type === '×ª×¨×•×¤×”' && l.detail.includes(med.name));
        
        if(lastTaken && (Date.now() - lastTaken.ts < med.hours * 3600000)) {
            document.getElementById('med-warning-text').innerText = `×©×™× ×œ×‘! ×”×ª×¨×•×¤×” ${med.name} × ×™×ª× ×” ×œ××—×¨×•× ×” ×œ×¤× ×™ ×¤×—×•×ª ×-${med.hours} ×©×¢×•×ª (×‘×©×¢×” ${lastTaken.time}). ×”×× ×œ×”××©×™×š?`;
            document.getElementById('btn-confirm-med').onclick = () => { logAction('×ª×¨×•×¤×”', `${med.name} (${med.dose})`); closeModal('modal-med-warning'); };
            openModal('modal-med-warning');
        } else {
            logAction('×ª×¨×•×¤×”', `${med.name} (${med.dose})`);
        }
    }

    // Measures
    function saveMeasure() {
        const w = document.getElementById('ms-w').value;
        const h = document.getElementById('ms-h').value;
        if(!w) return;
        db.measures.push({ w, h, date: new Date().toLocaleDateString('en-GB'), ts: Date.now() });
        save();
        showScreen('scr-home');
    }

    function renderCharts() {
        const last = db.measures[db.measures.length-1];
        if(last) document.getElementById('last-measure-text').innerText = `× ××“×“ ×œ××—×¨×•× ×”: ${last.w} ×§"×’ ×‘×ª××¨×™×š ${last.date}`;
        
        const ctx = document.getElementById('chartW').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.measures.map(m => m.date),
                datasets: [{ label: '××©×§×œ (×§×´×’)', data: db.measures.map(m => m.w), borderColor: '#6366f1' }]
            }
        });
    }

    // Calendar
    function renderCalendar() {
        const grid = document.getElementById('cal-grid');
        grid.innerHTML = '';
        for(let i=1; i<=31; i++) {
            const dateStr = i.toString().padStart(2,'0') + "/" + (new Date().getMonth()+1).toString().padStart(2,'0') + "/" + new Date().getFullYear();
            grid.innerHTML += `<div onclick="renderHistoryList('${dateStr}')" style="background:white; border:1px solid #ddd; padding:5px; text-align:center; border-radius:5px; cursor:pointer;">${i}</div>`;
        }
        renderHistoryList(new Date().toLocaleDateString('en-GB'));
    }

    function renderHistoryList(dateStr) {
        const list = document.getElementById('history-list');
        const items = db.logs.filter(l => l.date === dateStr);
        list.innerHTML = `<h3>×¤×¢×™×œ×•×ª ×¢×‘×•×¨ ${dateStr}</h3>` + (items.map(i => `<div class="btn-bar"><b>${i.time}</b> ${i.type}: ${i.detail}</div>`).join('') || "××™×Ÿ ×ª×™×¢×•×“ ×œ×™×•× ×–×”");
    }

    // Report Generation
    function generateReport() {
        const p = db.profile;
        let poop = 0, pee = 0, bSum = 0, bCount = 0;
        const today = new Date().toLocaleDateString('en-GB');
        
        db.logs.filter(l => l.date === today).forEach(l => {
            if(l.type === '×—×™×ª×•×œ') {
                if(l.detail.includes('×¤×™×¤×™')) pee++;
                if(l.detail.includes('×§×§×™')) poop++;
                if(l.detail.includes('×’× ×•×’×')) { pee++; poop++; }
            }
            if(l.type === '×‘×§×‘×•×§') {
                const val = parseInt(l.detail);
                if(val) { bSum += val; bCount++; }
            }
        });

        const reportHtml = `
            <div style="direction:rtl; text-align:right;">
                <h1>×“×•×— ××¦×‘ ×¨×¤×•××™ - ZoharApp</h1>
                <p><b>×©× ×”××˜×•×¤×œ/×ª:</b> ${p.name} ${p.lname}</p>
                <p><b>×ª××¨×™×š ×œ×™×“×”:</b> ${p.dob} | <b>×”×•×¨×™×:</b> ${p.mom}, ${p.dad}</p>
                <hr>
                <h2>×¡×™×›×•× ×™×•××™ (${today})</h2>
                <table>
                    <tr><td>×—×™×ª×•×œ×™ ×¤×™×¤×™</td><td>${pee}</td></tr>
                    <tr><td>×—×™×ª×•×œ×™ ×§×§×™</td><td>${poop}</td></tr>
                    <tr><td>×××•×¦×¢ ×”××›×œ×” (×‘×§×‘×•×§)</td><td>${bCount > 0 ? Math.round(bSum/bCount) : 0} ×"×œ</td></tr>
                    <tr><td>××©×§×œ ××—×¨×•×Ÿ</td><td>${db.measures.length ? db.measures[db.measures.length-1].w : '-'} ×§"×’</td></tr>
                </table>
                <h2>×ª×¨×•×¤×•×ª ×§×‘×•×¢×•×ª</h2>
                <table>
                    <tr><th>×©× ×”×ª×¨×•×¤×”</th><th>××™× ×•×Ÿ</th><th>××™× ×˜×¨×•×•×œ</th></tr>
                    ${db.meds.map(m => `<tr><td>${m.name}</td><td>${m.dose}</td><td>×›×œ ${m.hours} ×©×¢×•×ª</td></tr>`).join('')}
                </table>
            </div>
        `;
        document.getElementById('print-section').innerHTML = reportHtml;
        window.print();
    }

    function initApp() {
        if(!db.profile) showScreen('scr-onboarding');
        else showScreen('scr-home');
    }

    initApp();
</script>
</body>
</html>

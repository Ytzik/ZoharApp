<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZoharApp v37 - FULL VERSION FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap');
        
        :root {
            --rose: #fb7185;
            --blue: #3b82f6;
            --green: #10b981;
            --red: #ef4444; 
            --amber: #f59e0b;
            --indigo: #6366f1;
            --bg: #f1f5f9;
            --slate: #475569;
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Assistant', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            background: var(--bg); 
            margin: 0; 
            padding: 15px; 
            color: #0f172a; 
            direction: rtl; 
            line-height: 1.5;
        }

        /* Modal Styles */
        #custom-modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.8); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white; 
            width: 90%; 
            max-width: 400px; 
            padding: 30px; 
            border-radius: 28px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        /* Screen Management */
        .screen { 
            display: none; 
            max-width: 500px; 
            margin: 0 auto; 
            animation: slideUp 0.3s ease-out; 
        }

        .active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards and Elements */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            margin-bottom: 16px; 
            border: 1px solid #e2e8f0; 
        }

        .btn { 
            width: 100%; 
            padding: 18px; 
            border-radius: 18px; 
            border: none; 
            font-weight: 800; 
            cursor: pointer; 
            font-size: 17px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            transition: transform 0.1s;
        }

        .btn:active { transform: scale(0.98); }

        .btn-secondary { 
            background: white; 
            border: 2px solid #e2e8f0; 
            color: var(--slate); 
        }

        /* Inputs */
        input, select { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #e2e8f0; 
            border-radius: 14px; 
            font-size: 16px; 
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus { border-color: var(--indigo); }

        label { 
            display: block; 
            text-align: right; 
            font-weight: 600; 
            margin-top: 12px; 
            color: var(--slate); 
        }

        /* Timers and Specific Styles */
        .timer { 
            font-size: 56px; 
            font-weight: 800; 
            color: var(--rose); 
            margin: 20px 0; 
            font-family: monospace; 
            letter-spacing: 2px;
        }

        .nursing-active { background: var(--red) !important; color: white !important; }
        .bath-active { background: #06b6d4 !important; color: white !important; }
        
        .cal-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin: 20px 0; 
        }

        .cal-day { 
            padding: 12px 5px; 
            text-align: center; 
            border-radius: 12px; 
            cursor: pointer; 
            background: white; 
            font-weight: 600; 
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .cal-selected { background: var(--indigo) !important; color: white; }
        .cal-today { border: 2px solid var(--amber); }

        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 16px; 
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            #print-area { display: block !important; padding: 40px; }
        }
    </style>
</head>
<body>

    <div id="custom-modal">
        <div class="modal-content" id="modal-inner"></div>
    </div>

    <div id="scr-reg" class="screen">
        <div style="text-align:center; padding: 20px;">
            <h1 style="color:var(--rose); font-weight:800; font-size:32px;">ZoharApp</h1>
            <p>×”×¢×•×–×¨ ×”××™×©×™ ×©×œ×š ×œ×’×™×“×•×œ ×”×ª×™× ×•×§</p>
        </div>
        <div class="card">
            <h3>×¤×¨×•×¤×™×œ ×—×“×©</h3>
            <input type="text" id="reg-name" placeholder="×©× ×”×ª×™× ×•×§">
            <select id="reg-gender">
                <option value="">×‘×—×¨ ××™×Ÿ</option>
                <option value="×–×›×¨">×–×›×¨ ğŸ‘¦</option>
                <option value="× ×§×‘×”">× ×§×‘×” ğŸ‘§</option>
            </select>
            <label>×ª××¨×™×š ×œ×™×“×”:</label>
            <input type="date" id="reg-dob">
            <button class="btn" style="background:var(--rose); color:white; margin-top:10px;" onclick="Core.initProfile()">×‘×•××• × ×ª×—×™×œ</button>
        </div>
    </div>

    <div id="scr-home" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <h2 id="home-hello" style="margin:0;">×©×œ×•×</h2>
                <small id="home-date" style="color:var(--slate)"></small>
            </div>
            <div id="gender-icon" style="font-size:32px;"></div>
        </div>

        <div class="stats-grid">
            <div class="card" style="text-align:center; border-bottom:5px solid var(--rose); margin:0;">
                <small>××¨×•×—×” ××—×¨×•× ×”</small>
                <div id="stat-last-feed" style="font-weight:800; font-size:1.2em; margin-top:5px;">-</div>
            </div>
            <div class="card" style="text-align:center; border-bottom:5px solid var(--amber); margin:0;">
                <small>×—×™×ª×•×œ ××—×¨×•×Ÿ</small>
                <div id="stat-last-diaper" style="font-weight:800; font-size:1.2em; margin-top:5px;">-</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="card" onclick="Nav.to('scr-nursing')" style="border-right:6px solid var(--rose)">
                <b>ğŸ¤± ×”× ×§×”</b><br><small id="sub-nursing">-</small>
            </div>
            <div class="card" onclick="Core.openBottleModal()" style="border-right:6px solid var(--blue)">
                <b>ğŸ¼ ×‘×§×‘×•×§</b><br><small>×¨×™×©×•× ×›××•×ª</small>
            </div>
            <div class="card" onclick="Nav.to('scr-diaper')" style="border-right:6px solid var(--amber)">
                <b>âœ¨ ×—×™×ª×•×œ</b><br><small id="sub-diaper">-</small>
            </div>
            <div class="card" onclick="Nav.to('scr-sleep')" style="border-right:6px solid var(--indigo)">
                <b>ğŸŒ™ ×©×™× ×”</b><br><small id="sub-sleep">-</small>
            </div>
            <div class="card" onclick="Nav.to('scr-meds')" style="border-right:6px solid var(--red)">
                <b>ğŸ’Š ×ª×¨×•×¤×•×ª</b><br><small>× ×™×”×•×œ × ×˜×™×œ×”</small>
            </div>
            <div class="card" onclick="Nav.to('scr-meas')" style="border-right:6px solid var(--green)">
                <b>ğŸ“ˆ ××“×“×™×</b><br><small>××©×§×œ ×•×’×•×‘×”</small>
            </div>
            <button id="btn-bath" class="btn card" style="grid-column: span 2; border-right: 6px solid #06b6d4;" onclick="Core.doBath()">
                ğŸ› <b>×¨×—×¦×” ×™×•××™×ª</b>
            </button>
        </div>

        <div style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="Nav.to('scr-cal')">ğŸ“… ×™×•××Ÿ ×¤×¢×™×œ×•×ª ××œ×</button>
            <button class="btn" style="background:var(--slate); color:white; margin-top:10px;" onclick="Core.generateReport()">ğŸ“‹ ×”×¤×§×ª ×“×•×— ×œ×¨×•×¤×</button>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-secondary" style="font-size:12px; flex:1;" onclick="Core.exportData()">ğŸ“¤ ×’×™×‘×•×™</button>
            <button class="btn btn-secondary" style="font-size:12px; flex:1;" onclick="document.getElementById('file-in').click()">ğŸ“¥ ×©×—×–×•×¨</button>
            <input type="file" id="file-in" style="display:none" onchange="Core.importData(event)">
        </div>
    </div>

    <div id="scr-nursing" class="screen">
        <button class="btn btn-secondary no-print" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
        <div class="card" style="text-align:center; margin-top:15px;">
            <p id="n-info" style="color:var(--rose); font-weight:700;">×˜×¨× ×‘×•×¦×¢×” ×”× ×§×” ×”×™×•×</p>
            <div id="n-timer" class="timer">00:00</div>
            <div style="display:flex; gap:15px;">
                <button id="btn-R" class="btn btn-secondary" style="height:120px; flex:1;" onclick="Core.nursingSide('×™××™×Ÿ')">×¦×“ ×™××™×Ÿ</button>
                <button id="btn-L" class="btn btn-secondary" style="height:120px; flex:1;" onclick="Core.nursingSide('×©×××œ')">×¦×“ ×©×××œ</button>
            </div>
            <button class="btn" style="background:var(--green); color:white; margin-top:30px;" onclick="Core.nursingFinish()">×¡×™×•× ×•×¢×“×›×•×Ÿ</button>
        </div>
    </div>

    <div id="scr-sleep" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="stats-grid" style="margin-top:15px;">
            <div class="stat-box card" style="margin:0;">
                <small>×–××Ÿ ×©×™× ×” ×”×™×•×</small>
                <div id="sleep-today-stat" style="font-weight:800; font-size:16px;">-</div>
            </div>
            <div class="stat-box card" onclick="Core.openManualSleepModal()" style="margin:0; border:2px dashed var(--indigo); cursor:pointer;">
                <small>×”×–× ×” ×™×“× ×™×ª</small>
                <div style="font-size:14px; font-weight:800;">×”×•×¡×£ âœï¸</div>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <div id="s-timer" class="timer">00:00</div>
            <button id="s-btn" class="btn" style="height:140px; background:var(--indigo); color:white; font-size:22px;" onclick="Core.toggleSleep()">×”×ª×—×œ×ª ×©×™× ×” ğŸŒ™</button>
        </div>
    </div>

    <div id="scr-meds" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="card" style="margin-top:15px;">
            <h3>×ª×¨×•×¤×” ×—×“×©×”</h3>
            <input type="text" id="m-name" placeholder="×©× ×”×ª×¨×•×¤×” (×œ××©×œ: ×•×™×˜××™×Ÿ D)">
            <input type="text" id="m-dose" placeholder="××™× ×•×Ÿ (×œ××©×œ: 2 ×˜×™×¤×•×ª)">
            <input type="number" id="m-val" placeholder="×›×œ ×›××” ×©×¢×•×ª?">
            <button class="btn" style="background:var(--red); color:white;" onclick="Core.addMed()">×”×•×¡×£ ×œ×¨×©×™××”</button>
        </div>
        <div id="med-list"></div>
    </div>

    <div id="scr-diaper" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div style="margin-top:20px;">
            <button class="btn card" style="height:100px; font-size:20px;" onclick="Core.confirmDiaper('ğŸ’¦ ×¤×™×¤×™')">ğŸ’¦ ×¤×™×¤×™</button>
            <button class="btn card" style="height:100px; font-size:20px;" onclick="Core.confirmDiaper('ğŸ’© ×§×§×™')">ğŸ’© ×§×§×™</button>
            <button class="btn card" style="height:100px; font-size:20px;" onclick="Core.confirmDiaper('ğŸŒˆ ×’× ×•×’×')">ğŸŒˆ ×’× ×•×’×</button>
        </div>
    </div>

    <div id="scr-cal" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div id="cal-grid" class="cal-grid"></div>
        <div id="cal-summary-card" class="card" style="background:#eef2ff; border:1px solid var(--indigo);">
            <div id="cal-total-sleep" style="font-weight:800; color:var(--indigo);"></div>
        </div>
        <div id="cal-list"></div>
    </div>

    <div id="scr-meas" class="screen">
        <button class="btn btn-secondary" onclick="Nav.to('scr-home')">â¯ ×—×–×¨×”</button>
        <div class="card" style="margin-top:15px;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>××©×§×œ (×§"×’):</label>
                    <input type="number" id="ms-w" step="0.001" placeholder="0.000">
                </div>
                <div style="flex:1;">
                    <label>×’×•×‘×” (×¡"×):</label>
                    <input type="number" id="ms-h" placeholder="0">
                </div>
            </div>
            <button class="btn" style="background:var(--green); color:white; margin-top:10px;" onclick="Core.saveMeas()">×©××•×¨ × ×ª×•× ×™×</button>
        </div>
        <div class="card">
            <canvas id="chW"></canvas>
        </div>
    </div>

    <div id="print-area" style="display:none;"></div>

<script>
    const DB = {
        logs: JSON.parse(localStorage.getItem('z_logs')) || [],
        meds: JSON.parse(localStorage.getItem('z_meds')) || [],
        meas: JSON.parse(localStorage.getItem('z_meas')) || [],
        prof: JSON.parse(localStorage.getItem('z_prof')) || null,
        sleep: localStorage.getItem('z_sleep') || null,
        bath: localStorage.getItem('z_bath') || 0,
        nState: JSON.parse(localStorage.getItem('z_nstate')) || { side:null, ts:null, baseR:0, baseL:0 },
        lastN: JSON.parse(localStorage.getItem('z_lastN')) || {time:'-', side:'-'},
        
        save() {
            localStorage.setItem('z_logs', JSON.stringify(this.logs));
            localStorage.setItem('z_meds', JSON.stringify(this.meds));
            localStorage.setItem('z_meas', JSON.stringify(this.meas));
            localStorage.setItem('z_prof', JSON.stringify(this.prof));
            localStorage.setItem('z_bath', this.bath);
            if(this.sleep) localStorage.setItem('z_sleep', this.sleep); else localStorage.removeItem('z_sleep');
            localStorage.setItem('z_nstate', JSON.stringify(this.nState));
            localStorage.setItem('z_lastN', JSON.stringify(this.lastN));
        }
    };

    const UI = {
        modal(html) {
            document.getElementById('modal-inner').innerHTML = html;
            document.getElementById('custom-modal').style.display = 'flex';
        },
        close() { document.getElementById('custom-modal').style.display = 'none'; },

        // ×¤×•× ×§×¦×™×™×ª ×¢×™×‘×•×“ ×–××Ÿ ××¨×›×–×™×ª - ×”×ª×™×§×•×Ÿ ×”××‘×•×§×©
        formatSleepTime(totalMinutes) {
            const mins = parseInt(totalMinutes) || 0;
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h} ×©×¢×•×ª ×•-${m} ×“×§×•×ª`;
        },

        home() {
            if(!DB.prof) return Nav.to('scr-reg');
            document.getElementById('home-hello').innerText = `×”×™×•× ×©×œ ${DB.prof.name}`;
            document.getElementById('home-date').innerText = new Date().toLocaleDateString('he-IL', {weekday:'long', day:'numeric', month:'long'});
            document.getElementById('gender-icon').innerText = DB.prof.gender === '×–×›×¨' ? 'ğŸ‘¦' : 'ğŸ‘§';
            
            const today = new Date().toLocaleDateString('en-GB');
            const lastF = DB.logs.find(l => l.type==='×”× ×§×”' || l.type==='×‘×§×‘×•×§');
            document.getElementById('stat-last-feed').innerText = lastF ? lastF.time : '-';
            
            const lastD = DB.logs.find(l => l.type==='×—×™×ª×•×œ');
            document.getElementById('stat-last-diaper').innerText = lastD ? lastD.time : '-';
            
            document.getElementById('sub-nursing').innerText = `××—×¨×•× ×”: ${DB.lastN.time}`;
            document.getElementById('sub-sleep').innerText = this.formatSleepTime(Core.getDailySleepMins(today));
            
            const b = document.getElementById('btn-bath');
            if(Date.now() - DB.bath < 86400000) b.classList.add('bath-active'); else b.classList.remove('bath-active');
        },

        cal(dateStr) {
            const sel = dateStr || new Date().toLocaleDateString('en-GB');
            const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
            
            for(let i=1; i<=31; i++) {
                const d = i.toString().padStart(2,'0') + "/" + (new Date().getMonth()+1).toString().padStart(2,'0') + "/" + new Date().getFullYear();
                grid.innerHTML += `<div onclick="UI.cal('${d}')" class="cal-day ${sel===d?'cal-selected':''}">${i}</div>`;
            }
            
            const dayMins = Core.getDailySleepMins(sel);
            document.getElementById('cal-total-sleep').innerText = `×¡×™×›×•× ×©×™× ×” ×™×•××™: ${this.formatSleepTime(dayMins)}`;
            
            const logs = DB.logs.filter(l => l.date === sel);
            document.getElementById('cal-list').innerHTML = logs.length ? logs.map(l => `
                <div class="card" style="padding:12px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${l.time}</b>
                        <span style="color:var(--indigo)">${l.type}</span>
                    </div>
                    <div style="font-size:14px; margin-top:5px;">${l.detail}</div>
                </div>
            `).join('') : '<p style="text-align:center;">××™×Ÿ ×¨×™×©×•××™× ×œ×™×•× ×–×”</p>';
        }
    };

    const Nav = {
        to(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
            if(id === 'scr-home') UI.home();
            if(id === 'scr-cal') UI.cal();
            if(id === 'scr-sleep') Core.initSleepScreen();
            if(id === 'scr-meds') Core.renderMeds();
            if(id === 'scr-meas') Core.initMeasChart();
        }
    };

    const Core = {
        initProfile() {
            const name = document.getElementById('reg-name').value;
            const gender = document.getElementById('reg-gender').value;
            if(!name || !gender) return alert("× × ×œ××œ× ×©× ×•××™×Ÿ");
            DB.prof = { name, gender, dob: document.getElementById('reg-dob').value };
            DB.save(); Nav.to('scr-home');
        },

        log(type, detail) {
            const now = new Date();
            DB.logs.unshift({
                type,
                detail: detail.toString(),
                time: now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}),
                date: now.toLocaleDateString('en-GB'),
                ts: Date.now()
            });
            DB.save();
        },

        getDailySleepMins(dateStr) {
            return DB.logs
                .filter(l => l.date === dateStr && l.type === '×©×™× ×”')
                .reduce((acc, l) => acc + (parseInt(l.detail.replace(/\D/g, '')) || 0), 0);
        },

        // --- Nursing Logic ---
        nursingSide(side) {
            const now = Date.now();
            if(DB.nState.side) {
                const diff = Math.floor((now - DB.nState.ts) / 1000);
                if(DB.nState.side === '×™××™×Ÿ') DB.nState.baseR += diff; else DB.nState.baseL += diff;
            }
            DB.nState.side = (DB.nState.side === side) ? null : side;
            DB.nState.ts = now;
            DB.save(); this.updateNursingUI();
        },

        updateNursingUI() {
            document.getElementById('btn-R').classList.toggle('nursing-active', DB.nState.side === '×™××™×Ÿ');
            document.getElementById('btn-L').classList.toggle('nursing-active', DB.nState.side === '×©×××œ');
            clearInterval(window.nI);
            if(DB.nState.side) {
                window.nI = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - DB.nState.ts) / 1000);
                    const total = (DB.nState.side === '×™××™×Ÿ' ? DB.nState.baseR : DB.nState.baseL) + elapsed;
                    document.getElementById('n-timer').innerText = Math.floor(total/60).toString().padStart(2,'0') + ":" + (total%60).toString().padStart(2,'0');
                }, 1000);
            }
        },

        nursingFinish() {
            if(DB.nState.side) {
                const diff = Math.floor((Date.now() - DB.nState.ts) / 1000);
                if(DB.nState.side === '×™××™×Ÿ') DB.nState.baseR += diff; else DB.nState.baseL += diff;
            }
            const summary = `×™××™×Ÿ: ${Math.floor(DB.nState.baseR/60)} ×“×§', ×©×××œ: ${Math.floor(DB.nState.baseL/60)} ×“×§'`;
            this.log('×”× ×§×”', summary);
            DB.lastN = { time: new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}), side: DB.nState.baseR >= DB.nState.baseL ? '×™××™×Ÿ' : '×©×××œ' };
            DB.nState = { side:null, ts:null, baseR:0, baseL:0 };
            DB.save(); Nav.to('scr-home');
        },

        // --- Sleep Logic ---
        initSleepScreen() {
            const today = new Date().toLocaleDateString('en-GB');
            document.getElementById('sleep-today-stat').innerText = UI.formatSleepTime(this.getDailySleepMins(today));
            this.updateSleepTimer();
        },

        toggleSleep() {
            if(!DB.sleep) {
                DB.sleep = Date.now();
            } else {
                const diffMins = Math.floor((Date.now() - DB.sleep) / 60000);
                this.log('×©×™× ×”', diffMins + " ×“×§×•×ª");
                DB.sleep = null;
            }
            DB.save(); this.initSleepScreen();
        },

        updateSleepTimer() {
            clearInterval(window.sI);
            const btn = document.getElementById('s-btn');
            if(DB.sleep) {
                btn.innerText = "×‘×•×§×¨ ×˜×•×‘ â˜€ï¸";
                btn.style.background = "var(--amber)";
                window.sI = setInterval(() => {
                    const sec = Math.floor((Date.now() - DB.sleep) / 1000);
                    document.getElementById('s-timer').innerText = Math.floor(sec/60).toString().padStart(2,'0') + ":" + (sec%60).toString().padStart(2,'0');
                }, 1000);
            } else {
                btn.innerText = "×”×ª×—×œ×ª ×©×™× ×” ğŸŒ™";
                btn.style.background = "var(--indigo)";
                document.getElementById('s-timer').innerText = "00:00";
            }
        },

        openManualSleepModal() {
            UI.modal(`
                <h3>×”×•×¡×¤×ª ×©×™× ×” ×™×“× ×™×ª</h3>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="man-h" placeholder="×©×¢×•×ª">
                    <input type="number" id="man-m" placeholder="×“×§×•×ª">
                </div>
                <button class="btn" style="background:var(--indigo); color:white; margin-top:15px;" onclick="Core.saveManualSleep()">×©××•×¨</button>
            `);
        },

        saveManualSleep() {
            const h = parseInt(document.getElementById('man-h').value) || 0;
            const m = parseInt(document.getElementById('man-m').value) || 0;
            this.log('×©×™× ×”', (h * 60 + m) + " ×“×§×•×ª");
            UI.close(); this.initSleepScreen();
        },

        // --- Meds Logic - ×”×ª×™×§×•×Ÿ ×”×©× ×™ ×”××‘×•×§×© ---
        addMed() {
            const nameEl = document.getElementById('m-name');
            const doseEl = document.getElementById('m-dose');
            const valEl = document.getElementById('m-val');
            
            if(!nameEl.value) return;
            
            DB.meds.push({
                id: Date.now(),
                name: nameEl.value,
                dose: doseEl.value,
                hrs: valEl.value
            });
            
            DB.save();
            // ××™×¤×•×¡ ×©×“×•×ª ××™×™×“×™
            nameEl.value = '';
            doseEl.value = '';
            valEl.value = '';
            
            this.renderMeds();
        },

        renderMeds() {
            const list = document.getElementById('med-list');
            list.innerHTML = DB.meds.map(m => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="font-size:18px;">${m.name}</b><br>
                        <small>${m.dose} (×›×œ ${m.hrs} ×©×¢×•×ª)</small>
                    </div>
                    <button class="btn" style="width:auto; padding:8px 20px; background:var(--green); color:white;" onclick="Core.log('×ª×¨×•×¤×”', '${m.name}')">× ×˜×™×œ×”</button>
                </div>
            `).join('');
        },

        // --- Utils ---
        confirmDiaper(type) {
            UI.modal(`
                <h3>××™×©×•×¨ ×—×™×ª×•×œ</h3>
                <p>×”×× ×œ×¨×©×•× ×”×—×œ×¤×ª <b>${type}</b>?</p>
                <button class="btn" style="background:var(--amber); color:white;" onclick="Core.log('×—×™×ª×•×œ', '${type}'); UI.close(); Nav.to('scr-home');">×›×Ÿ, ×¨×©×•×</button>
            `);
        },

        openBottleModal() {
            UI.modal(`
                <h3>ğŸ¼ ×‘×§×‘×•×§</h3>
                <input type="number" id="b-amt" placeholder="×›××•×ª ×‘××´×œ">
                <button class="btn" style="background:var(--blue); color:white;" onclick="Core.log('×‘×§×‘×•×§', document.getElementById('b-amt').value + ' ××´×œ'); UI.close(); Nav.to('scr-home');">×©××•×¨</button>
            `);
        },

        doBath() { DB.bath = Date.now(); DB.save(); UI.home(); },

        generateReport() {
            const today = new Date().toLocaleDateString('en-GB');
            const logs = DB.logs.filter(l => l.date === today);
            const html = `
                <div style="direction:rtl; text-align:right; font-family:sans-serif;">
                    <h1>×“×•×— ×™×•××™ - ${DB.prof.name}</h1>
                    <p>×ª××¨×™×š: ${today}</p>
                    <hr>
                    ${logs.map(l => `<p><b>${l.time}</b>: ${l.type} - ${l.detail}</p>`).join('')}
                </div>
            `;
            const win = window.open('', '_blank');
            win.document.write(html);
            win.print();
        },

        exportData() {
            const data = JSON.stringify(DB);
            const blob = new Blob([data], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `zohar_backup_${new Date().toLocaleDateString()}.json`;
            a.click();
        },

        importData(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imported = JSON.parse(ev.target.result);
                Object.assign(DB, imported);
                DB.save();
                location.reload();
            };
            reader.readAsText(e.target.files[0]);
        },

        initMeasChart() {
            if(window.myChart) window.myChart.destroy();
            const ctx = document.getElementById('chW').getContext('2d');
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: DB.meas.map(m => m.date),
                    datasets: [{
                        label: '××©×§×œ (×§"×’)',
                        data: DB.meas.map(m => m.w),
                        borderColor: '#3b82f6',
                        tension: 0.1
                    }]
                }
            });
        },

        saveMeas() {
            const w = document.getElementById('ms-w').value;
            const h = document.getElementById('ms-h').value;
            if(!w) return;
            DB.meas.push({ w, h, date: new Date().toLocaleDateString('en-GB') });
            DB.save(); Nav.to('scr-home');
        }
    };

    // Start App
    Nav.to('scr-home');
</script>
</body>
</html>
